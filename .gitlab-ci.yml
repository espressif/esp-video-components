stages:
  - pre_check
  - build
  - target_test

workflow:
  rules:
    # Disable those non-protected push triggered pipelines
    - if: '$CI_COMMIT_REF_NAME != "main" && $CI_COMMIT_BRANCH !~ /^release\/v/ && $CI_COMMIT_TAG !~ /^v\d+\.\d+(\.\d+)?($|-)/ && $CI_PIPELINE_SOURCE == "push"'
      when: never
    # when running merged result pipelines, CI_COMMIT_SHA represents the temp commit it created.
    # Please use PIPELINE_COMMIT_SHA at all places that require a commit sha of the original commit.
    - if: $CI_OPEN_MERGE_REQUESTS != null
      variables:
        PIPELINE_COMMIT_SHA: $CI_MERGE_REQUEST_SOURCE_BRANCH_SHA
        IS_MR_PIPELINE: 1
    - if: $CI_OPEN_MERGE_REQUESTS == null
      variables:
        PIPELINE_COMMIT_SHA: $CI_COMMIT_SHA
        IS_MR_PIPELINE: 0
    - when: always

################################################
# `before_script` and `after_script` Templates #
################################################
.common_before_scripts: &common-before_scripts |
  source tools/ci/utils.sh

.pull_idf_master_branch: &pull_idf_master_branch |
  # ESP32-P4 need use ESP-IDF master branch which supports ISP driver

  if [[ "$EXAMPLE_TARGET" == "esp32p4" ]]; then
    add_gitlab_ssh_keys
    cd $IDF_PATH
    git remote set-url origin ${GITLAB_SSH_SERVER}/espressif/esp-idf.git
    git pull origin master || echo "Fetch esp-idf error and skip"
    git submodule update --init --recursive
    ./install.sh
    cd -
  fi

.setup_tools_and_idf_python_venv: &setup_tools_and_idf_python_venv |
  # must use after setup_tools_except_target_test
  # otherwise the export.sh won't work properly

  # Install esp-clang if necessary
  if [[ "$IDF_TOOLCHAIN" == "clang" ]]; then
    $IDF_PATH/tools/idf_tools.py --non-interactive install esp-clang
  fi

  source $IDF_PATH/export.sh

.before_script:build:
  before_script:
    - *common-before_scripts
    - *pull_idf_master_branch
    - *setup_tools_and_idf_python_venv

include:
  - '.gitlab/ci/rules.yml'
  - '.gitlab/ci/static-code-analysis.yml'
  - '.gitlab/ci/pre_check.yml'
  - '.gitlab/ci/build.yml'
  - '.gitlab/ci/target_test.yml'
